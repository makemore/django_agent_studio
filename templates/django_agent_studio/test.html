{% extends "django_agent_studio/base.html" %}

{% block title %}Test {{ agent.name }} - {{ studio_app_name }}{% endblock %}

{% block breadcrumbs %}
<nav class="flex items-center space-x-2 ml-4 text-sm">
    <span class="text-white/40">/</span>
    <a href="{% url 'agent_studio:agent_list' %}" class="text-white/60 hover:text-white/90 transition-colors">My Agents</a>
    <span class="text-white/40">/</span>
    <a href="{% url 'agent_studio:agent_edit' agent.id %}" class="text-white/60 hover:text-white/90 transition-colors">{{ agent.name }}</a>
    <span class="text-white/40">/</span>
    <span class="text-white/70">Test</span>
</nav>
{% endblock %}

{% block extra_head %}
<style>
    #fullscreen-chat-container .cw-container {
        position: absolute !important;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100% !important;
        height: 100% !important;
        max-height: none !important;
        border-radius: 0 !important;
        box-shadow: none !important;
    }

    #fullscreen-chat-container .cw-toggle-btn {
        display: none !important;
    }

    #fullscreen-chat-container .cw-widget {
        position: absolute !important;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100% !important;
        height: 100% !important;
        max-height: none !important;
        border-radius: 0 !important;
        display: flex !important;
        flex-direction: column !important;
        overflow: hidden !important;
    }

    #fullscreen-chat-container .cw-messages {
        flex: 1 !important;
        min-height: 0 !important;
        overflow-y: auto !important;
    }
    
    #fullscreen-chat-container .cw-header {
        background: {{ studio_colors.primary }} !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="h-full flex flex-col">
    <!-- Agent Info Bar -->
    <div class="px-5 py-3 bg-white border-b border-slate-200 flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <div class="w-10 h-10 bg-cyan/10 rounded-lg flex items-center justify-center">
                <span class="text-xl">{{ agent.icon|default:"ü§ñ" }}</span>
            </div>
            <div>
                <h1 class="font-semibold text-navy">{{ agent.name }}</h1>
                <p class="text-sm text-slate-500">{{ agent.description|default:"No description"|truncatechars:100 }}</p>
            </div>
        </div>
        <div class="flex items-center space-x-3">
            <a href="{% url 'agent_studio:agent_collaborators' agent.id %}"
               class="text-slate-500 hover:text-navy px-3 py-1.5 border border-slate-200 rounded-lg text-sm transition-colors hover:border-cyan"
               title="Manage collaborators">
                <i class="pi pi-users"></i>
            </a>
            <a href="{% url 'agent_studio:agent_edit' agent.id %}"
               class="text-slate-500 hover:text-navy px-3 py-1.5 border border-slate-200 rounded-lg text-sm transition-colors hover:border-cyan">
                ‚Üê Back to Editor
            </a>
            <button @click="clearChat"
                    class="text-white bg-navy hover:bg-navy-light px-4 py-1.5 rounded-lg text-sm font-medium transition-all hover:shadow-md">
                Clear Chat
            </button>
        </div>
    </div>
    
    <!-- Full Screen Chat -->
    <div class="flex-1 min-h-0 relative bg-gradient-to-br from-slate-50 to-slate-100">
        <div id="fullscreen-chat-container" class="absolute inset-0"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const { createApp } = Vue;

const agentSlug = "{{ agent.slug|escapejs }}";
const backendUrl = window.location.origin;

function initChat() {
    if (window.testChatWidget) {
        window.testChatWidget.destroy();
    }
    
    window.testChatWidget = ChatWidget.createInstance({
        containerId: 'fullscreen-chat-container',
        backendUrl: backendUrl,
        agentKey: agentSlug,
        title: '{{ agent.name|escapejs }}',
        primaryColor: '{{ studio_chat_primary_color }}',
        showClearButton: true,
        showDebugButton: true,
        showExpandButton: false,
        embedded: true,
        apiPaths: {
            runs: '/api/agent-runtime/runs/',
            runEvents: '/api/agent-runtime/runs/{runId}/events/',
        },
    });
}

createApp({
    data() {
        return {}
    },
    methods: {
        clearChat() {
            if (window.testChatWidget) {
                window.testChatWidget.clearMessages();
            }
        }
    },
    mounted() {
        initChat();
    }
}).use(primevue.config.default).mount('#app');
</script>
{% endblock %}
